name: Notify Discord on Specific File Changes

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

jobs:
  notify-if-data-changed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v3

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/arkadiyt/bounty-targets-data.git
          git fetch upstream

      - name: Check for changes in target files
        id: check_diff
        run: |
          git fetch upstream
          git diff --name-only HEAD..upstream/master > changed_files.txt
          cat changed_files.txt

          if grep -qE 'data/(bugcrowd_data\.json|intigriti_data\.json)' changed_files.txt; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "CHANGES<<EOF" >> $GITHUB_ENV
            git diff HEAD..upstream/master -- data/bugcrowd_data.json data/intigriti_data.json > file_changes.diff || echo "No diff"
            cat file_changes.diff >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream if changed
        if: steps.check_diff.outputs.changed == 'true'
        run: |
          git merge upstream/master --allow-unrelated-histories -m "Sync with upstream changes"
          git push origin HEAD:master

      - name: Send Discord Notification for Changes
        if: steps.check_diff.outputs.changed == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.https://discord.com/api/webhooks/1271818703356297226/RcjQ9wKd27kTNb4vxeaWqmnM4D6y1ltYdu-3CinUcH1I-rtFWKkt2x-Ahz89VZ_u18BD }}
        run: |
          DIFF_CONTENT="${{ env.CHANGES }}"
          CHUNK_SIZE=1900  # Max length per message (leaving space for formatting)
          TOTAL_LENGTH=${#DIFF_CONTENT}

          # Send messages in chunks if necessary
          for (( i=0; i<TOTAL_LENGTH; i+=CHUNK_SIZE )); do
            PART="${DIFF_CONTENT:i:CHUNK_SIZE}"
            curl -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\": \"ðŸ”” **Update detected in \`bugcrowd_data.json\` or \`intigriti_data.json\`**\n\`\`\`\n$PART\n\`\`\`\"}" \
              $DISCORD_WEBHOOK_URL
          done

      - name: Send Discord Notification for No Changes
        if: steps.check_diff.outputs.changed == 'false'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.https://discord.com/api/webhooks/1271818703356297226/RcjQ9wKd27kTNb4vxeaWqmnM4D6y1ltYdu-3CinUcH1I-rtFWKkt2x-Ahz89VZ_u18BD }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"ðŸš« **No changes detected in \`bugcrowd_data.json\` or \`intigriti_data.json\`**\"}" \
            $DISCORD_WEBHOOK_URL
