name: Notify Discord on JSON Changes

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

jobs:
  notify-if-data-changed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch latest bounty data
        run: |
          curl -sSL https://raw.githubusercontent.com/arkadiyt/bounty-targets-data/main/data/bugcrowd_data.json -o bugcrowd_latest.json
          curl -sSL https://raw.githubusercontent.com/arkadiyt/bounty-targets-data/main/data/intigriti_data.json -o intigriti_latest.json

      - name: Restore previous files if exist
        run: |
          mkdir -p previous
          cp bugcrowd_latest.json previous/bugcrowd_previous.json || true
          cp intigriti_latest.json previous/intigriti_previous.json || true

      - name: Save current files for next comparison
        run: |
          mkdir -p snapshot
          cp bugcrowd_latest.json snapshot/bugcrowd_snapshot.json
          cp intigriti_latest.json snapshot/intigriti_snapshot.json

      - name: Compare JSON and save diff
        id: diff
        run: |
          sudo apt-get install -y jq diffutils
          
          DIFF_BC=$(diff -u previous/bugcrowd_previous.json bugcrowd_latest.json || true)
          DIFF_INT=$(diff -u previous/intigriti_previous.json intigriti_latest.json || true)
          
          FULL_DIFF="$DIFF_BC"$'\n'"$DIFF_INT"
          
          if [ -n "$FULL_DIFF" ]; then
            echo "diff_found=true" >> "$GITHUB_OUTPUT"
            echo "$FULL_DIFF" > full_diff.txt
          else
            echo "diff_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Discord Notification
        if: steps.diff.outputs.diff_found == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT=$(cat full_diff.txt | head -c 1900)
          ESCAPED=$(echo "$CONTENT" | sed 's/"/\\"/g')

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"ðŸ”” **JSON changes detected:**\n\`\`\`diff\n$ESCAPED\n\`\`\`\"}"

      - name: Upload latest as artifact for next run
        uses: actions/upload-artifact@v3
        with:
          name: previous-jsons
          path: snapshot/
